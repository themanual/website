<% title "#{@piece.title}, by #{@piece.author.name}" %>
<% cache @piece do %>
<article class="piece is-<%= @piece.type.downcase %> issue-<%= @piece.issue_number %> c-issue l-section-x hentry"><div>

  <header class="piece-header">
    <% if @piece.illustrator %>
    <%- metadata "og:image",        image_url("#{@piece.illo_basepath}-750w.jpg") if @piece.illustrator.present? -%>
    <div class="piece-header-illustration">
      <figure class="entry-content-asset">
        <%=
        tag "img",
            sizes: "(min-width: 850px) 27em, 100vw",
            srcset: srcset(base: @piece.illo_basepath, format: "jpg", sizes: %w(300 500 750 1000 1500))
        %>
      </figure>
    </div>
    <% end %>

    <div class="piece-header-text">
      <p class="piece-header-author byline vcard"><span class="fn author" rel="author"><%= @piece.author.name %></span></p>
      <h1 class="piece-header-title entry-title"><%= @piece.title %></h1>
      <h2 class="piece-header-synopsis entry-summary"><%= @piece.synopsis %></h2>
      <p class="piece-header-metadata">
        <span class="piece-header-silo">In <%= link_to "Issue #{@piece.issue_number}", issue_path(issue: @piece.issue_number) %></span>
        <span class="piece-header-topics">On <a href="#">Culture</a>, <a href="#">History</a>, <a href="#">Process</a></span>
      </p>
    </div>
  </header>

  <div class="piece-body l-reading entry-content">
    <%=raw Kramdown::Document.new(@piece.body).to_html %>
  </div>

  <footer class="piece-author l-reading">
    <figure class="piece-author-portrait">
      <%= portrait_tag(@piece) %>
    </figure>
    <div class="piece-author-bio text">
      <p><%= raw @piece.author.bio %></p>
      <p>
        <%= link_to piece_path(@piece.companion.issue.number, @piece.companion.author_slug, @piece.companion.class.name.underscore.to_sym), class: "button in-sc is-small" do %>
          Read Next: <%= @piece.author.name.given_name.possessive %> <%= @piece.companion.type %>
        <% end %>
      </p>
    </div>
  </footer>

</div></article>
<% end %>

<% cache [@piece, 'explore'], expires_in: 30.minutes do %>
<aside class="l-section-x piece-post"><div>
  <section class="piece-post-issue issue-<%= @piece.issue_number %> c-issue">
    <h2 class="box-title">Part of <%= link_to "Issue #{@piece.issue_number}", issue_path(@piece.issue_number) %></h2>
    <div class="text">
      <ul class="plain">
      <% @piece.issue.authors.each do |author| %>
        <%= content_tag :li, author.name, class: ('marker-arrow' if author == @piece.author) %>
      <% end %>
      </ul>
      <p><%= link_to "Browse Issue #{@piece.issue_number}", issue_path(@piece.issue_number) %></p>
    </div>
  </section>
  <section class="piece-post-topics">
    <h2 class="box-title">Related Topics</h2>
    <div class="text">
      <ul class="plain loose">
      <%  @piece.topics.where("taggings_count > 1").each do |topic| %>
        <li>
          <h5><%= link_to(topic.name.titlecase, topic_path(topic: topic.name.downcase)) %></h5>
          <p><strong><%= topic.taggings_count %></strong> Pieces</p>
        </li>
      <% end %>
      </ul>
    </div>
  </section>
  <section class="piece-post-piece">
    <h2 class="box-title">Recommended in <%= link_to "Staff Picks", staffpicks_path, class: "c-issue-#{@piece.recommended.issue_number}" %></h2>
    <div>
    <%= render :partial => 'shared/units/piece', :object  => @piece.recommended %>
    </div>
  </section>
</div></aside>

<% end %>

<aside class="support bg-gray l-line-t"><div>
  <div class="support-illo">
    <figure>
      <%= image_tag "ui/big-devices.png" %>
    </figure>
  </div>
  <div class="support-text text t-big">
    <h4>Avalaible for free thanks to our supporters.</h4>
    <p>We’re a <a href="#">100% independent publication</a>, and rely on our readers’ support to continue publishing online for free. <strong>If you liked this piece, please consider supporting us.</strong></p>
    <p>
      <button class="button is-large">Subscribe to The Manual</button>
      <span class="br-s">or</span>
      <a href="#">browse the shop.</a>
    </p>
  </div>
</div></aside>

<% content_for :footer do %>
<script>$(function() { $('.piece-body').footnotes(); });</script>
<% end %>
