<% push_page_title ["#{@piece.title}, by #{@piece.author.name}", "Issue #{@piece.issue_number}"] %>

<main class="issue-<%= @piece.issue_number %>" role="main">
  <% cache @piece do %>

    <!-- Article -->
    <article class="issue-piece is-<%= @piece.type.downcase %>"><div class="l-wrapper">

      <%= render 'piece_header' %>

      <div class="issue-piece-text">
        <%=raw Kramdown::Document.new(@piece.body).to_html %>
      </div>

      <%= render 'piece_footer' %>
    </div></article>

    <aside class="issue-pagination"><div>
      <ul class="issue-pagination-list">
        <li class="issue-pagination-item is-previous">
        <% if (prev_article = @piece.prev) %>
          <a href="<%= prev_article.path %>">
            <h2><%= prev_article.author.name %></h2>
            <p><strong class="piece-title"><%= prev_article.title %></strong></p>
          </a>
        <% end %>
        </li>

        <li class="issue-pagination-item is-current">
          <a class="issue-<%= @piece.issue_number %>" href="<%= issue_url @piece.issue_number %>">
            <h2>Browse Issue&nbsp;<%= @piece.issue_number %></h2>
          </a>
        </li>


        <li class="issue-pagination-item is-next">
        <% if (next_article = @piece.next) %>
          <a href="<%= next_article.path %>">
            <h2><%= next_article.author.name %></h2>
            <p><strong class="piece-title"><%= next_article.title %></strong></p>
          </a>
        <% end %>
        </li>

      </ul>
    </div></aside>
  <% end %>

  <% cache [@piece, :random], expires_in: 300.ish do %>
    <aside class="boxes"><div class="l-grid-padded">

    <!-- <div class="box-group l-col-half"> -->

      <section class="box l-col-half">
        <h2 class="box-title">
          Read something from <a href="/issues/<%= @piece.random.issue_number %>" class="issue-<%= @piece.random.issue_number %>">Issue <%= @piece.random.issue_number %></a>
        </h2>
        <%= render 'featured_piece', featured: @piece.random %>
      </section>

      <section class="box l-col-half">
        <h2 class="box-title">
          <a class="issue-current" href="<%= issue_url(@piece.issue_number) %>">Buy this issue</a> and support The Manual
        </h2>

        <div class="issuebuy">
          <figure class="issuebuy-figure">
            <%= image_tag "ui/devices-#{@piece.issue_number}.png" %>
          </figure>
          <%= render 'issue_buy_options', sub: false, issue: @piece.issue %>
        </div>
      </section>

    <!-- </div> -->

    </div></aside>
  <% end %>

</main>
